---
# Deploy cloudkitty
cifmw_deploy_obs: true
cifmw_openshift_obs_definition:
  apiVersion: operators.coreos.com/v1alpha1
  kind: Subscription
  metadata:
    name: observability-operator
    namespace: openshift-operators
  spec:
    channel: stable
    installPlanApproval: Automatic
    name: cluster-observability-operator
    source: redhat-operators
    sourceNamespace: openshift-marketplace

# TODO: To use the images created by the content provider, we need to add in the images here until there's support in openstack operator to pull them in the expected way.

# from fvt/ci/vars/common.yml should be used from there eventually.
telemetry_registry: >-
  {%- if content_provider_os_registry_url is defined and content_provider_os_registry_url != 'null' -%}
  {{ content_provider_os_registry_url  }}
  {%- else -%}
  quay.rdoproject.org/podified-master-centos10
  {%- endif -%}

telemetry_tag: >-
  {%- if content_provider_os_registry_url is defined and content_provider_os_registry_url != 'null' -%}
  telemetry_latest
  {%- else -%}
  current-tested
  {%- endif -%}

_ck_api_image: "{{ telemetry_registry }}/openstack-cloudkitty-api:{{ telemetry_tag }}"
_ck_proc_image: "{{ telemetry_registry }}/openstack-cloudkitty-processor:{{ telemetry_tag }}"

# This is removed for now.
#pre_deploy_kustomize_cloudkitty:
#  source: "{{ ansible_user_dir }}/{{ zuul.projects['github.com/openstack-k8s-operators/telemetry-operator'].src_dir }}/ci/configure-cloudkitty.yml"
#  type: playbook
#  extra_vars:
#    cloudkitty_api_image: "{{ _ck_api_image }}
#    cloudkitty_proc_image: "{{ _ck_proc_image }}"
# TODO: Adapt the deploy-logging-dependencies role to allow config necessary for CK
# # I can remove the vars-logging from the job definition.
#pre_deploy_deploy_logging_dependencies:
#  source: "{{ ansible_user_dir }}/{{ zuul.projects['github.com/openstack-k8s-operators/telemetry-operator'].src_dir }}/ci/deploy-logging-dependencies.yml"
#  type: playbook
post_deploy_enable_cloudkitty:
  source: "{{ ansible_user_dir }}/{{ zuul.projects['github.com/openstack-k8s-operators/telemetry-operator'].src_dir }}/ci/cloudkitty-post_deploy.yml"
  type: playbook
  extra_vars:
    cloudkitty_api_image: "{{ _ck_api_image }}"
    cloudkitty_proc_image: "{{ _ck_proc_image }}"

# test cloudkitty
cifmw_run_tests: true
cifmw_run_test_role: test_operator
# TODO: Consider switching to podified-master-centos10 for features that patch master
# This also needs the registry_url configured.
# The master container is using an old constraints file, so revertng to antelope until https://github.com/openstack-k8s-operators/tcib/pull/328 is merged
#cifmw_test_operator_tempest_namespace: podified-master-centos10
#
# cloudkitty tempest plugin is not part of the tempest rpm.
# https://review.rdoproject.org/cgit/openstack/tempest-distgit/tree/openstack-tempest.spec
# We need to add the cloudkitty-tempest-plugin package to RDO, same as TTTP
# https://review.rdoproject.org/cgit/openstack/telemetry-tempest-plugin-distgit/#
# For now, we can force install using the cifmw_test_operator_tempest_external_plugin below.
cifmw_test_operator_tempest_container: openstack-tempest-all
cifmw_test_operator_tempest_image_tag: 'current-podified'
# This value is used to populate the `tempestconfRun` parameter of the Tempest CR: https://openstack-k8s-operators.github.io/test-operator/crds.html#tempest-custom-resource
# https://github.com/openstack-k8s-operators/ci-framework/blob/main/roles/test_operator/defaults/main.yml
# TODO: Refine this tempest config
tempest_conf:
  overrides: |
      validation.run_validation true
      identity.v3_endpoint_type public
      service_available.ceilometer true
      service_available.sg_core true
      service_available.aodh true
      service_available.cinder false
      telemetry.sg_core_service_url "https://ceilometer-internal.openstack.svc.cluster.local:3000"
      telemetry.prometheus_service_url "https://metric-storage-prometheus.openstack.svc.cluster.local:9090"
      telemetry.ceilometer_polling_interval 120
      telemetry.prometheus_scrape_interval 30
      telemetry.alarm_threshold 50000000000
cifmw_test_operator_tempest_tempestconf_config: "{{ tempest_conf }}"
cifmw_test_operator_tempest_include_list: |
  ^tempest.*\[.*\bsmoke\b.*\]
  cloudkitty_tempest_plugin.*
  telemetry_tempest_plugin.*
#cifmw_test_operator_tempest_exclude_list: |
#  telemetry_tempest_plugin.scenario.test_telemetry_integration_prometheus.PrometheusGabbiTest.test_autoscaling
# TODO: update this to allow multiple external plugins to be listed with Depends-On.
# Potentially, this can be done via the meta content provider, by adding the tempest images to the list.
external_plugin: "opendev.org/openstack/cloudkitty-tempest-plugin"
change_item: "{{ zuul['items'] | selectattr('project.canonical_name', 'equalto', external_plugin) }}"
# This is a workaround because CK tempest is not packages in RDO. Typically, the default would be [], since we would not require an external installation.
# TODO: add the cloudkitty-tempest-plugin to RDO
cifmw_test_operator_tempest_external_plugin: "{{ [ {'repository': 'https://' + external_plugin + '.git'} ] if change_item | length < 1 else [ { 'repository': 'https://' + external_plugin + '.git', 'changeRepository': 'https://review' + external_plugin, 'changeRefspec': [ 'refs/changes', change_item[0].change[-2:], change_item[0].change, change_item[0].patchset ] | join('/') } ] }}"
